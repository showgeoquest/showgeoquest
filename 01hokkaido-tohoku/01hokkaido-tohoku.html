<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>北海道・東北 | SHOW GEO QUEST</title>
  <link rel="stylesheet" href="style.css" />

  <!-- このページ専用：リンクの下線を消す／小さめフッター（他のボタン外観は触らない） -->
  <style>
    .site-footer{
      width: min(860px, 94vw);
      margin: 10px auto 0;
      display:flex;
      justify-content:flex-end;
      opacity:.78;
      font-size: 12px;
      padding: 0 6px 10px;
    }
    .site-footer a{
      color: rgba(242,246,255,.70);
      text-decoration: none;
    }
    .site-footer a:hover{ opacity: 1; }

    /* 地方ページ：モード選択の見出しを少しだけ整える */
    .region-title{
      text-align:center;
      font-weight: 900;
      letter-spacing: .6px;
      margin: 10px 0 6px;
    }
    .region-sub{
      text-align:center;
      color: rgba(242,246,255,.70);
      margin: 0 0 10px;
      font-size: 14px;
    }

    .mode-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 14px;
    }
    @media (max-width: 700px){
      .mode-grid{ grid-template-columns: 1fr; }
    }

    .mode-note{
      margin-top: 12px;
      color: rgba(242,246,255,.72);
      font-size: 13px;
      line-height: 1.55;
    }

    /* 学習用の小さなリスト */
    .study-list{
      margin: 8px 0 0;
      padding-left: 18px;
      color: rgba(242,246,255,.85);
    }
    .study-badge{
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(160,220,255,.25);
      background: rgba(20,90,255,.10);
      font-size: 12px;
      margin-left: 6px;
      opacity:.95;
    }

    /* クイズの選択肢ボタン（既存.btnを使い、サイズだけ調整） */
    .choices{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 520px){
      .choices{ grid-template-columns: 1fr; }
    }

    .hud{
      display:flex;
      gap: 10px;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      color: rgba(242,246,255,.78);
      font-size: 13px;
    }

    .timer{
      font-weight: 900;
      letter-spacing: .6px;
      color: rgba(242,246,255,.90);
    }

    /* ちょい演出：残り1秒でドキッ（揺れ） */
    @keyframes doki {
      0%{ transform: translateX(0); }
      25%{ transform: translateX(-2px); }
      50%{ transform: translateX(2px); }
      75%{ transform: translateX(-2px); }
      100%{ transform: translateX(0); }
    }
    .doki{ animation: doki .18s linear infinite; }

    /* 地図クリック用の案内 */
    .map-hint{
      margin: 8px 0 0;
      color: rgba(242,246,255,.72);
      font-size: 13px;
      text-align:center;
    }

    /* objectの中のSVGを“クリック可能に見せる”ための枠 */
    .map-wrap{
      margin-top: 10px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.18);
      overflow:hidden;
    }
    .map-svg-region{
      width: 100%;
      height: 360px;
      display:block;
    }
    @media (max-width: 700px){
      .map-svg-region{ height: 300px; }
    }

    /* 小さい戻る */
    .topbar{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }
    .topbar .title{
      font-weight: 900;
      letter-spacing: .6px;
      font-size: 14px;
      opacity: .9;
    }
  </style>
</head>

<body>
  <main class="frame">

    <!-- ====== 地方ページ：北海道・東北 ====== -->
    <section id="screen-region" class="screen">
      <!-- 背景（任意）：日本列島SVG -->
      <div class="title-map" aria-hidden="true">
        <object class="map-svg" data="japan.svg" type="image/svg+xml" tabindex="-1"></object>
      </div>

      <div class="hero">
        <div class="logo" aria-label="SHOW GEO QUEST">
          <div class="logo-line">SHOW GEO</div>
          <div class="logo-line logo-boltline">
            <span class="bolt">⚡</span>
            <span class="quest">QUEST</span>
            <span class="bolt">⚡</span>
          </div>
        </div>

        <div class="region-title">北海道・東北クエスト</div>
        <p class="region-sub">モードを選んでスタート</p>
      </div>

      <div class="menu">
        <div class="mode-grid">
          <button class="btn region" id="btnStudy" type="button">学習用</button>
          <button class="btn region" id="btnQuizLocation" type="button">位置を選ぶ</button>
          <button class="btn region" id="btnQuizName" type="button">名前を選ぶ</button>
          <button class="btn region" id="btnQuizCapital" type="button">県庁所在地</button>
        </div>

        <div class="divider"></div>

        <div class="card" style="margin-top:0">
          <p class="hint" style="margin:0">
            ルール（クイズ共通）：全10問 / 1問5秒 / 正解10点 / 間違いは正解するまで続行<br>
            同じ都道府県は「連続で出ない」「10問中2回まで」
          </p>
        </div>
      </div>
    </section>

    <!-- ====== 学習用 ====== -->
    <section id="screen-study" class="screen" hidden>
      <div class="topbar">
        <button class="btn small ghost" id="backFromStudy" type="button">×</button>
        <div class="title">学習用（北海道・東北）</div>
        <div style="width:36px"></div>
      </div>

      <div class="card">
        <p class="hint" style="margin:0 0 8px">
          地図をクリックすると、都道府県名と県庁所在地が表示されます（正解・不正解なし）。
        </p>

        <div class="map-wrap">
          <!-- ★ここはあなたの地方SVGファイル名に合わせて変えてOK -->
          <object id="regionMapStudy" class="map-svg-region"
                  data="hokkaido-tohoku.svg"
                  type="image/svg+xml"></object>
        </div>

        <p id="studyInfo" class="map-hint">地図をクリックしてね</p>

        <div class="divider"></div>

        <p class="hint" style="margin:0 0 6px">
          「県名と異なる県庁所在地」<span class="study-badge">要注意</span>
        </p>
        <ul class="study-list" id="studyMismatchList"></ul>
      </div>
    </section>

    <!-- ====== クイズ：位置を選ぶ ====== -->
    <section id="screen-quiz-location" class="screen" hidden>
      <div class="topbar">
        <button class="btn small ghost" id="backFromLocation" type="button">×</button>
        <div class="title">位置を選ぶ（北海道・東北）</div>
        <div style="width:36px"></div>
      </div>

      <div class="card" id="cardLocation">
        <p class="hint">出題：<span id="qLocation">---</span></p>

        <div class="hud">
          <div>問題 <span id="locIndex">0</span>/10</div>
          <div>得点 <span id="locScore">0</span> 点</div>
          <div class="timer">残り <span id="locTime">5</span>s</div>
        </div>

        <div class="map-wrap">
          <object id="regionMapLocation" class="map-svg-region"
                  data="hokkaido-tohoku.svg"
                  type="image/svg+xml"></object>
        </div>

        <p id="locResult" class="result">都道府県をクリック！</p>

        <div class="row">
          <button class="btn small" id="locStart" type="button">スタート</button>
          <button class="btn small ghost" id="locRetry" type="button" disabled>やり直し</button>
        </div>
      </div>
    </section>

    <!-- ====== クイズ：名前を選ぶ ====== -->
    <section id="screen-quiz-name" class="screen" hidden>
      <div class="topbar">
        <button class="btn small ghost" id="backFromName" type="button">×</button>
        <div class="title">名前を選ぶ（北海道・東北）</div>
        <div style="width:36px"></div>
      </div>

      <div class="card" id="cardName">
        <p class="hint">出題：<span id="qName">---</span></p>

        <div class="hud">
          <div>問題 <span id="nameIndex">0</span>/10</div>
          <div>得点 <span id="nameScore">0</span> 点</div>
          <div class="timer">残り <span id="nameTime">5</span>s</div>
        </div>

        <div class="map-wrap">
          <object id="regionMapName" class="map-svg-region"
                  data="hokkaido-tohoku.svg"
                  type="image/svg+xml"></object>
        </div>

        <div class="choices" id="nameChoices"></div>

        <p id="nameResult" class="result">---</p>

        <div class="row">
          <button class="btn small" id="nameStart" type="button">スタート</button>
          <button class="btn small ghost" id="nameRetry" type="button" disabled>やり直し</button>
        </div>
      </div>
    </section>

    <!-- ====== クイズ：県庁所在地 ====== -->
    <section id="screen-quiz-capital" class="screen" hidden>
      <div class="topbar">
        <button class="btn small ghost" id="backFromCapital" type="button">×</button>
        <div class="title">県庁所在地（北海道・東北）</div>
        <div style="width:36px"></div>
      </div>

      <div class="card" id="cardCapital">
        <p class="hint">出題：<span id="qCapital">---</span></p>

        <div class="hud">
          <div>問題 <span id="capIndex">0</span>/10</div>
          <div>得点 <span id="capScore">0</span> 点</div>
          <div class="timer">残り <span id="capTime">5</span>s</div>
        </div>

        <div class="choices" id="capChoices"></div>

        <p id="capResult" class="result">---</p>

        <div class="row">
          <button class="btn small" id="capStart" type="button">スタート</button>
          <button class="btn small ghost" id="capRetry" type="button" disabled>やり直し</button>
        </div>
      </div>
    </section>

  </main>

  <!-- フッター（小さく右下寄せ。下線なし） -->
  <footer class="site-footer">
    <a href="about.html" aria-label="利用規約・製作者について">利用規約・製作者</a>
    <span style="opacity:.45;margin:0 8px;">/</span>
    <a href="index.html" aria-label="タイトルへ戻る">タイトル</a>
  </footer>

  <script>
    // =========================
    // データ：北海道・東北
    // =========================
    const PREFS = [
      { code: "1",  name: "北海道",   capital: "札幌市" },
      { code: "2",  name: "青森県",   capital: "青森市" },
      { code: "3",  name: "岩手県",   capital: "盛岡市" },
      { code: "4",  name: "宮城県",   capital: "仙台市" },
      { code: "5",  name: "秋田県",   capital: "秋田市" },
      { code: "6",  name: "山形県",   capital: "山形市" },
      { code: "7",  name: "福島県",   capital: "福島市" },
    ];

    // 県名と県庁所在地名が一致しない（学習用に強調）
    const MISMATCH = PREFS.filter(p => {
      // 「北海道」は県ではないけど、学習上は“道名と市名が違う”扱いで入れる
      const base = p.name.replace("県","");
      return p.capital !== base && p.name !== "青森県" && p.name !== "秋田県" && p.name !== "山形県" && p.name !== "福島県";
    });

    // 似てる名前デコイ（「宮城/宮崎」「福井/福島」など：ゲーム性）
    const DECOY_PREFS = ["宮崎県","福井県","富山県","長崎県","大分県","福岡県","鳥取県","島根県","栃木県","群馬県"];

    // =========================
    // 画面切替
    // =========================
    const screens = {
      region: document.getElementById("screen-region"),
      study: document.getElementById("screen-study"),
      loc:   document.getElementById("screen-quiz-location"),
      name:  document.getElementById("screen-quiz-name"),
      cap:   document.getElementById("screen-quiz-capital"),
    };

    function showScreen(key){
      Object.keys(screens).forEach(k => screens[k].hidden = (k !== key));
    }

    // region → 各モード
    document.getElementById("btnStudy").addEventListener("click", () => showScreen("study"));
    document.getElementById("btnQuizLocation").addEventListener("click", () => showScreen("loc"));
    document.getElementById("btnQuizName").addEventListener("click", () => showScreen("name"));
    document.getElementById("btnQuizCapital").addEventListener("click", () => showScreen("cap"));

    // 各モード → region
    document.getElementById("backFromStudy").addEventListener("click", () => showScreen("region"));
    document.getElementById("backFromLocation").addEventListener("click", () => showScreen("region"));
    document.getElementById("backFromName").addEventListener("click", () => showScreen("region"));
    document.getElementById("backFromCapital").addEventListener("click", () => showScreen("region"));

    // =========================
    // SVG objectを扱う補助
    // =========================
    function withSvg(objectEl, cb){
      const tryGet = () => {
        const doc = objectEl.contentDocument;
        if (doc && doc.documentElement) cb(doc);
        else setTimeout(tryGet, 60);
      };
      tryGet();
    }

    function getPrefElementByCode(svgDoc, code){
      // geoloniaのSVG想定：data-code="xx" がprefecture gに付く
      return svgDoc.querySelector(`.prefecture[data-code="${code}"], g.prefecture[data-code="${code}"]`)
          || svgDoc.querySelector(`[data-code="${code}"]`);
    }

    function clearHighlights(svgDoc){
      svgDoc.querySelectorAll("[data-sgq-highlight]").forEach(el => {
        el.removeAttribute("data-sgq-highlight");
        el.style.filter = "";
        el.style.opacity = "";
        el.style.strokeWidth = "";
      });
    }

    function highlightPref(svgDoc, code){
      clearHighlights(svgDoc);
      const g = getPrefElementByCode(svgDoc, code);
      if (!g) return;
      g.setAttribute("data-sgq-highlight","1");
      g.style.filter = "drop-shadow(0 0 10px rgba(120,180,255,.45))";
      g.style.opacity = "1";
      g.style.strokeWidth = "2.2";
    }

    // =========================
    // 学習用
    // =========================
    const mismatchListEl = document.getElementById("studyMismatchList");
    mismatchListEl.innerHTML = "";
    // 学習用に “道”も含めて分かりやすく
    const mismatchDisplay = [
      { name: "北海道", capital: "札幌市" },
      { name: "岩手県", capital: "盛岡市" },
      { name: "宮城県", capital: "仙台市" },
    ];
    mismatchDisplay.forEach(item => {
      const li = document.createElement("li");
      li.textContent = `${item.name}：${item.capital}`;
      mismatchListEl.appendChild(li);
    });

    const studyInfo = document.getElementById("studyInfo");
    const regionMapStudy = document.getElementById("regionMapStudy");

    withSvg(regionMapStudy, (doc) => {
      doc.addEventListener("click", (e) => {
        const target = e.target.closest("[data-code]");
        if (!target) return;

        const code = target.getAttribute("data-code");
        const pref = PREFS.find(p => p.code === code);
        if (!pref) return;

        highlightPref(doc, code);
        studyInfo.textContent = `${pref.name} / 県庁所在地：${pref.capital}`;
      });
    });

    // =========================
    // 共通：クイズ出題器（10問/同一連続なし/最大2回）
    // =========================
    function buildQuizSequence(){
      const maxPerPref = 2;
      const counts = new Map(PREFS.map(p => [p.code, 0]));
      const seq = [];

      let last = null;
      while (seq.length < 10){
        const candidates = PREFS.filter(p => {
          if (p.code === last) return false;
          if ((counts.get(p.code) || 0) >= maxPerPref) return false;
          return true;
        });

        // 全部埋まったら（理論上少ないけど）条件をゆるめる
        const pool = candidates.length ? candidates : PREFS.filter(p => p.code !== last);

        const pick = pool[Math.floor(Math.random() * pool.length)];
        seq.push(pick);
        counts.set(pick.code, (counts.get(pick.code) || 0) + 1);
        last = pick.code;
      }
      return seq;
    }

    function startCountdown({timeEl, cardEl, onTimeout}){
      let t = 5;
      timeEl.textContent = String(t);
      cardEl.classList.remove("doki");

      const timer = setInterval(() => {
        t--;
        timeEl.textContent = String(Math.max(t, 0));
        if (t <= 1) cardEl.classList.add("doki");
        if (t < 0){
          clearInterval(timer);
          cardEl.classList.remove("doki");
          onTimeout();
        }
      }, 1000);

      return () => {
        clearInterval(timer);
        cardEl.classList.remove("doki");
      };
    }

    // =========================
    // クイズ：位置を選ぶ（クリックで回答）
    // =========================
    const loc = {
      card: document.getElementById("cardLocation"),
      q: document.getElementById("qLocation"),
      index: document.getElementById("locIndex"),
      score: document.getElementById("locScore"),
      time: document.getElementById("locTime"),
      result: document.getElementById("locResult"),
      startBtn: document.getElementById("locStart"),
      retryBtn: document.getElementById("locRetry"),
      mapObj: document.getElementById("regionMapLocation"),
      seq: [],
      i: 0,
      scoreVal: 0,
      current: null,
      stopTimer: null,
      running: false,
      svgDoc: null,
    };

    withSvg(loc.mapObj, (doc) => {
      loc.svgDoc = doc;
      doc.addEventListener("click", (e) => {
        if (!loc.running || !loc.current) return;
        const target = e.target.closest("[data-code]");
        if (!target) return;
        const code = target.getAttribute("data-code");
        if (!PREFS.some(p => p.code === code)) return;

        if (code === loc.current.code){
          loc.scoreVal += 10;
          loc.score.textContent = String(loc.scoreVal);
          loc.result.textContent = "正解！";
          loc.next();
        }else{
          loc.result.textContent = "不正解。もう一度！";
          // 続行：問題は進めない
        }
      });
    });

    loc.ask = function(){
      loc.current = loc.seq[loc.i];
      loc.index.textContent = String(loc.i + 1);
      loc.q.textContent = `${loc.current.name} をクリック！`;
      loc.result.textContent = "都道府県をクリック！";
      if (loc.svgDoc) highlightPref(loc.svgDoc, loc.current.code);

      if (loc.stopTimer) loc.stopTimer();
      loc.stopTimer = startCountdown({
        timeEl: loc.time,
        cardEl: loc.card,
        onTimeout: () => {
          // タイムアップ＝不正解扱いで同じ問題続行
          loc.result.textContent = "時間切れ。もう一度！";
          loc.ask();
        }
      });
    };

    loc.next = function(){
      if (loc.stopTimer) loc.stopTimer();
      if (loc.svgDoc) clearHighlights(loc.svgDoc);

      loc.i++;
      if (loc.i >= 10){
        loc.running = false;
        loc.result.textContent = `終了！ 得点：${loc.scoreVal} 点`;
        loc.startBtn.disabled = false;
        loc.retryBtn.disabled = false;
        return;
      }
      loc.ask();
    };

    loc.reset = function(){
      if (loc.stopTimer) loc.stopTimer();
      loc.seq = buildQuizSequence();
      loc.i = 0;
      loc.scoreVal = 0;
      loc.score.textContent = "0";
      loc.startBtn.disabled = false;
      loc.retryBtn.disabled = true;
      loc.running = false;
      loc.index.textContent = "0";
      loc.time.textContent = "5";
      loc.q.textContent = "---";
      loc.result.textContent = "スタートを押してね";
      if (loc.svgDoc) clearHighlights(loc.svgDoc);
    };

    loc.startBtn.addEventListener("click", () => {
      loc.seq = buildQuizSequence();
      loc.i = 0;
      loc.scoreVal = 0;
      loc.score.textContent = "0";
      loc.running = true;
      loc.startBtn.disabled = true;
      loc.retryBtn.disabled = true;
      loc.ask();
    });

    loc.retryBtn.addEventListener("click", () => loc.reset());
    loc.reset();

    // =========================
    // クイズ：名前を選ぶ（4択）
    // =========================
    const nameQ = {
      card: document.getElementById("cardName"),
      q: document.getElementById("qName"),
      index: document.getElementById("nameIndex"),
      score: document.getElementById("nameScore"),
      time: document.getElementById("nameTime"),
      result: document.getElementById("nameResult"),
      choices: document.getElementById("nameChoices"),
      startBtn: document.getElementById("nameStart"),
      retryBtn: document.getElementById("nameRetry"),
      mapObj: document.getElementById("regionMapName"),
      seq: [],
      i: 0,
      scoreVal: 0,
      current: null,
      stopTimer: null,
      running: false,
      svgDoc: null,
    };

    withSvg(nameQ.mapObj, (doc) => { nameQ.svgDoc = doc; });

    function pickNameChoices(correctName){
      // 基本は地方内から＋ゲーム性デコイを少し混ぜる
      const poolLocal = PREFS.map(p => p.name);
      const pool = [...new Set([...poolLocal, ...DECOY_PREFS])].filter(n => n !== correctName);

      const picks = [];
      while (picks.length < 3){
        const c = pool[Math.floor(Math.random() * pool.length)];
        if (!picks.includes(c)) picks.push(c);
      }

      const all = [correctName, ...picks];
      // shuffle
      for (let i = all.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [all[i], all[j]] = [all[j], all[i]];
      }
      return all;
    }

    nameQ.renderChoices = function(){
      nameQ.choices.innerHTML = "";
      const correct = nameQ.current.name;
      const options = pickNameChoices(correct);

      options.forEach(opt => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "btn small";
        b.textContent = opt;
        b.addEventListener("click", () => {
          if (!nameQ.running) return;
          if (opt === correct){
            nameQ.scoreVal += 10;
            nameQ.score.textContent = String(nameQ.scoreVal);
            nameQ.result.textContent = "正解！";
            nameQ.next();
          }else{
            nameQ.result.textContent = "不正解。もう一度！";
          }
        });
        nameQ.choices.appendChild(b);
      });
    };

    nameQ.ask = function(){
      nameQ.current = nameQ.seq[nameQ.i];
      nameQ.index.textContent = String(nameQ.i + 1);
      nameQ.q.textContent = "光っている都道府県はどれ？";
      nameQ.result.textContent = "---";

      if (nameQ.svgDoc) highlightPref(nameQ.svgDoc, nameQ.current.code);

      nameQ.renderChoices();

      if (nameQ.stopTimer) nameQ.stopTimer();
      nameQ.stopTimer = startCountdown({
        timeEl: nameQ.time,
        cardEl: nameQ.card,
        onTimeout: () => {
          nameQ.result.textContent = "時間切れ。もう一度！";
          nameQ.ask();
        }
      });
    };

    nameQ.next = function(){
      if (nameQ.stopTimer) nameQ.stopTimer();
      if (nameQ.svgDoc) clearHighlights(nameQ.svgDoc);

      nameQ.i++;
      if (nameQ.i >= 10){
        nameQ.running = false;
        nameQ.result.textContent = `終了！ 得点：${nameQ.scoreVal} 点`;
        nameQ.startBtn.disabled = false;
        nameQ.retryBtn.disabled = false;
        return;
      }
      nameQ.ask();
    };

    nameQ.reset = function(){
      if (nameQ.stopTimer) nameQ.stopTimer();
      nameQ.seq = buildQuizSequence();
      nameQ.i = 0;
      nameQ.scoreVal = 0;
      nameQ.score.textContent = "0";
      nameQ.startBtn.disabled = false;
      nameQ.retryBtn.disabled = true;
      nameQ.running = false;
      nameQ.index.textContent = "0";
      nameQ.time.textContent = "5";
      nameQ.q.textContent = "---";
      nameQ.result.textContent = "スタートを押してね";
      nameQ.choices.innerHTML = "";
      if (nameQ.svgDoc) clearHighlights(nameQ.svgDoc);
    };

    nameQ.startBtn.addEventListener("click", () => {
      nameQ.seq = buildQuizSequence();
      nameQ.i = 0;
      nameQ.scoreVal = 0;
      nameQ.score.textContent = "0";
      nameQ.running = true;
      nameQ.startBtn.disabled = true;
      nameQ.retryBtn.disabled = true;
      nameQ.ask();
    });

    nameQ.retryBtn.addEventListener("click", () => nameQ.reset());
    nameQ.reset();

    // =========================
    // クイズ：県庁所在地（4択 / 不一致を重点）
    // =========================
    const cap = {
      card: document.getElementById("cardCapital"),
      q: document.getElementById("qCapital"),
      index: document.getElementById("capIndex"),
      score: document.getElementById("capScore"),
      time: document.getElementById("capTime"),
      result: document.getElementById("capResult"),
      choices: document.getElementById("capChoices"),
      startBtn: document.getElementById("capStart"),
      retryBtn: document.getElementById("capRetry"),
      seq: [],
      i: 0,
      scoreVal: 0,
      current: null,
      stopTimer: null,
      running: false,
      // questionType: "prefToCity" or "cityToPref"
      qType: null,
    };

    function buildCapitalSequence(){
      // 不一致（北海道/岩手/宮城）を多めに、ただし10問に満たないので混ぜる
      const focus = [
        { name: "北海道", capital: "札幌市" },
        { name: "岩手県", capital: "盛岡市" },
        { name: "宮城県", capital: "仙台市" },
      ];
      const rest = PREFS.map(p => ({ name: p.name, capital: p.capital }));
      const all = [...focus, ...rest];

      // 10問作る：focusを優先して回しながら、連続は避ける
      const seq = [];
      const counts = new Map();
      let last = null;

      while (seq.length < 10){
        const pool = all.filter(x => x.name !== last);
        // focusは出やすく
        const weighted = [];
        pool.forEach(x => {
          const isFocus = focus.some(f => f.name === x.name);
          const c = counts.get(x.name) || 0;
          if (c >= 2) return; // 同一は2回まで
          const w = isFocus ? 3 : 1;
          for (let k=0;k<w;k++) weighted.push(x);
        });
        if (!weighted.length) break;

        const pick = weighted[Math.floor(Math.random() * weighted.length)];
        seq.push(pick);
        counts.set(pick.name, (counts.get(pick.name) || 0) + 1);
        last = pick.name;
      }

      // もし足りなければ埋める
      while (seq.length < 10){
        const cand = all.find(x => (counts.get(x.name) || 0) < 2 && x.name !== last) || all[0];
        seq.push(cand);
        counts.set(cand.name, (counts.get(cand.name) || 0) + 1);
        last = cand.name;
      }

      return seq;
    }

    function pickCapitalChoices(correct, mode){
      // mode: "city" -> 都市名を選ばせる / "pref" -> 都道府県名を選ばせる
      const pool = mode === "city"
        ? [...new Set(PREFS.map(p => p.capital).concat(["盛岡市","仙台市","札幌市","福井市","宮崎市"]))].filter(x => x !== correct)
        : [...new Set(PREFS.map(p => p.name).concat(DECOY_PREFS))].filter(x => x !== correct);

      const picks = [];
      while (picks.length < 3){
        const c = pool[Math.floor(Math.random() * pool.length)];
        if (!picks.includes(c)) picks.push(c);
      }

      const all = [correct, ...picks];
      for (let i = all.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [all[i], all[j]] = [all[j], all[i]];
      }
      return all;
    }

    cap.renderChoices = function(correct, mode){
      cap.choices.innerHTML = "";
      const options = pickCapitalChoices(correct, mode);

      options.forEach(opt => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "btn small";
        b.textContent = opt;
        b.addEventListener("click", () => {
          if (!cap.running) return;
          if (opt === correct){
            cap.scoreVal += 10;
            cap.score.textContent = String(cap.scoreVal);
            cap.result.textContent = "正解！";
            cap.next();
          }else{
            cap.result.textContent = "不正解。もう一度！";
          }
        });
        cap.choices.appendChild(b);
      });
    };

    cap.ask = function(){
      cap.current = cap.seq[cap.i];
      cap.index.textContent = String(cap.i + 1);

      // 交互に出す（演繹/帰納）
      cap.qType = (cap.i % 2 === 0) ? "prefToCity" : "cityToPref";

      if (cap.qType === "prefToCity"){
        cap.q.textContent = `${cap.current.name} の県庁所在地は？`;
        cap.renderChoices(cap.current.capital, "city");
      }else{
        cap.q.textContent = `${cap.current.capital} は何（都道府県）の県庁所在地？`;
        cap.renderChoices(cap.current.name, "pref");
      }

      cap.result.textContent = "---";

      if (cap.stopTimer) cap.stopTimer();
      cap.stopTimer = startCountdown({
        timeEl: cap.time,
        cardEl: cap.card,
        onTimeout: () => {
          cap.result.textContent = "時間切れ。もう一度！";
          cap.ask();
        }
      });
    };

    cap.next = function(){
      if (cap.stopTimer) cap.stopTimer();

      cap.i++;
      if (cap.i >= 10){
        cap.running = false;
        cap.result.textContent = `終了！ 得点：${cap.scoreVal} 点`;
        cap.startBtn.disabled = false;
        cap.retryBtn.disabled = false;
        return;
      }
      cap.ask();
    };

    cap.reset = function(){
      if (cap.stopTimer) cap.stopTimer();
      cap.seq = buildCapitalSequence();
      cap.i = 0;
      cap.scoreVal = 0;
      cap.score.textContent = "0";
      cap.startBtn.disabled = false;
      cap.retryBtn.disabled = true;
      cap.running = false;
      cap.index.textContent = "0";
      cap.time.textContent = "5";
      cap.q.textContent = "---";
      cap.result.textContent = "スタートを押してね";
      cap.choices.innerHTML = "";
    };

    cap.startBtn.addEventListener("click", () => {
      cap.seq = buildCapitalSequence();
      cap.i = 0;
      cap.scoreVal = 0;
      cap.score.textContent = "0";
      cap.running = true;
      cap.startBtn.disabled = true;
      cap.retryBtn.disabled = true;
      cap.ask();
    });

    cap.retryBtn.addEventListener("click", () => cap.reset());
    cap.reset();

    // 初期表示
    showScreen("region");
  </script>
</body>
</html>
