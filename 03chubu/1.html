<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>知識の泉｜中部</title>

<link rel="stylesheet" href="../style.css" />

<style>
  :root{
    color-scheme: dark;

    --bg:#14356f;
    --textLite: rgba(246,251,255,.96);

    --panel: rgba(245,252,255,.94);
    --border: rgba(190,235,255,.36);
    --text:#0f1f26;

    --land:#dff0df;
    --landTarget:#cfe8cf;
    --landHover:#bfe2ff;
    --stroke:#6f8f6f;

    --prefBlue:#1466ff;
    --alert:#ff3b3b;

    --labelMax: 8.5em;
  }

  *{ box-sizing:border-box; }

  html{ height:100%; min-height:100%; background: var(--bg); }
  body{
    margin:0;
    min-height:100vh;
    font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    position: relative;
    background: transparent;
    color: var(--textLite);
    display:grid;
    place-items:start center;
    padding: 14px 0 26px;
  }
  body::before{
    content:"";
    position: fixed;
    inset: 0;
    z-index: -1;
    pointer-events: none;
    background:
      radial-gradient(1200px 760px at 50% 6%,  rgba(165,230,255,.44), transparent 60%),
      radial-gradient(1100px 700px at 50% 40%, rgba(120,200,255,.28), transparent 62%),
      radial-gradient(1100px 680px at 50% 92%, rgba(120,200,255,.18), transparent 70%),
      linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,0) 28%),
      var(--bg);
  }

  .frame{
    width: min(900px, 94vw);
    padding: 18px 16px 16px;
    border-radius: 22px;
    background:
      radial-gradient(900px 520px at 50% 18%, rgba(190,245,255,.12), transparent 62%),
      linear-gradient(180deg, rgba(231,243,247,.12), rgba(242,251,255,.06));
    border: 1px solid rgba(190,235,255,.22);
    box-shadow: 0 18px 60px rgba(0,0,0,.20);
    position: relative;
    overflow: hidden;
  }

  .headerRow{
    display:grid;
    grid-template-columns: auto 1fr auto;
    align-items:center;
    gap: 10px;
    margin-bottom: 10px;
  }
  .back{
    display:inline-flex;
    align-items:center;
    gap: 8px;
    padding: 10px 12px;
    border-radius: 14px;
    text-decoration:none;
    font-weight: 900;
    letter-spacing:.2px;
    color: rgba(246,251,255,.96);
    border: 1px solid rgba(210,245,255,.30);
    background:
      linear-gradient(180deg, rgba(255,255,255,.08), transparent 45%),
      linear-gradient(135deg, rgba(45,125,255,.72), rgba(170,225,255,.18));
    box-shadow:
      0 12px 28px rgba(0,0,0,.18),
      inset 0 1px 0 rgba(255,255,255,.10);
    white-space: nowrap;
  }
  .back:hover{ filter: brightness(1.08); }
  .back:active{ transform: translateY(1px); }

  .headerTitle{
    text-align:center;
    font-weight: 1000;
    letter-spacing:.2px;
    font-size: 16px;
    color: rgba(246,251,255,.86);
    text-shadow: 0 0 16px rgba(165,230,255,.18);
    white-space: nowrap;
    overflow:hidden;
    text-overflow: ellipsis;
  }
  .headerSpacer{ width: 1px; height: 1px; }

  .stage{
    position: relative;
    width: 100%;
    height: min(74vh, 760px);
    min-height: 520px;
    border-radius: 20px;
    overflow: hidden;
    background:
      radial-gradient(900px 520px at 50% 18%, rgba(190,245,255,.14), transparent 62%),
      linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    box-shadow: 0 14px 44px rgba(0,0,0,.18);
  }

  #svgHost{ position:absolute; inset:0; }
  #svgHost svg{ width:100%; height:100%; display:block; }

  .geolonia-svg-map .prefecture{
    fill: var(--land) !important;
    stroke: var(--stroke) !important;
    stroke-width: 1 !important;
  }
  .geolonia-svg-map .prefecture.is-target{ fill: var(--landTarget) !important; }
  .geolonia-svg-map .prefecture.is-target:hover{
    fill: var(--landHover) !important;
    cursor: pointer;
  }
  .geolonia-svg-map .prefecture.not-target{
    pointer-events: none !important;
    opacity: .55;
  }

  #tapLabel{
    position:absolute;
    z-index: 6;
    transform: translate(-50%, -118%);
    max-width: var(--labelMax);
    padding: 8px 12px;
    border-radius: 14px;
    background: rgba(245,252,255,.96);
    border: 1px solid var(--border);
    text-align:center;
    font-weight: 1000;
    color: var(--prefBlue);
    font-size: 20px;
    line-height: 1.12;
    display:none;
    pointer-events:none;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    box-shadow: 0 12px 26px rgba(0,0,0,.18);
  }
  #tapLabel rt{
    font-size: 11px;
    font-weight: 900;
    color: rgba(20,102,255,.68);
  }
  #tapLabel.alert{
    color: var(--alert);
    font-size: 22px;
  }
  #tapLabel.alert rt{ color: rgba(255,59,59,.75); }

  .infoPanel{
    position:absolute;
    right: 14px;
    bottom: 84px;
    z-index: 6;
    width: 240px;
    max-width: 78vw;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 18px;
    padding: 12px 12px;
    box-shadow: 0 16px 40px rgba(0,0,0,.12);
    pointer-events: none;
    color: var(--text);
  }
  .pref{
    font-size: 18px;
    font-weight: 1000;
    letter-spacing:.02em;
    color: var(--prefBlue);
    line-height: 1.15;
    text-align:center;
  }
  .pref rt{
    font-size: 11px;
    font-weight: 900;
    color: rgba(20,102,255,.68);
  }
  .cap{
    margin-top: 10px;
    font-size: 16px;
    font-weight: 1000;
    text-align:center;
    line-height: 1.15;
  }
  .cap rt{
    font-size: 11px;
    font-weight: 900;
    color: rgba(15,31,38,.55);
  }
  .cap.alertText{
    color: var(--alert);
    font-size: 18px;
  }
</style>
</head>

<body>
  <main class="frame" aria-label="知識の泉（中部）">
    <div class="headerRow">
      <a class="back" href="./index.html" aria-label="中部へ戻る">
        <span class="arrow">←</span>
        <span>中部へ戻る</span>
      </a>
      <div class="headerTitle">知識の泉</div>
      <div class="headerSpacer" aria-hidden="true"></div>
    </div>

    <div class="stage" id="stage">
      <div id="svgHost"></div>
      <div id="tapLabel"></div>

      <div class="infoPanel" aria-live="polite">
        <div class="pref" id="prefLine">県をタップ</div>
        <div class="cap" id="capLine">—</div>
      </div>
    </div>
  </main>

<script>
  const MAP_PATH = "../maps/japan.svg";
  const VIEWBOX  = "535 -25 535 700";

  const TARGET_CLASSES = ["niigata","toyama","ishikawa","fukui","yamanashi","nagano","gifu","shizuoka","aichi"];

  const DATA = {
    "新潟県": { pref:"にいがたけん", cap:"にいがたし",   capName:"新潟市" },
    "富山県": { pref:"とやまけん",   cap:"とやまし",     capName:"富山市" },
    "石川県": { pref:"いしかわけん", cap:"かなざわし",   capName:"金沢市" },
    "福井県": { pref:"ふくいけん",   cap:"ふくいし",     capName:"福井市" },
    "山梨県": { pref:"やまなしけん", cap:"こうふし",     capName:"甲府市" },
    "長野県": { pref:"ながのけん",   cap:"ながのし",     capName:"長野市" },
    "岐阜県": { pref:"ぎふけん",     cap:"ぎふし",       capName:"岐阜市" },
    "静岡県": { pref:"しずおかけん", cap:"しずおかし",   capName:"静岡市" },
    "愛知県": { pref:"あいちけん",   cap:"なごやし",     capName:"名古屋市" },
  };

  function coreName(name){
    return (name || "").replace(/(都|道|府|県|市|区)$/g,"");
  }
  function isMismatch(prefFull, capName){
    return coreName(prefFull) !== coreName(capName);
  }
  function rubyHTML(base, kana){
    if(!base) return "—";
    if(!kana) return base;
    return `<ruby>${base}<rt>${kana}</rt></ruby>`;
  }

  function pickPrefName(el){
    const t = el.querySelector("title")?.textContent;
    if(t) return t.split("/")[0].trim();
    const aria = el.getAttribute("aria-label");
    if(aria) return aria.trim();
    const dn = el.dataset && (el.dataset.name || el.dataset.pref || el.dataset.prefName);
    if(dn) return String(dn).trim();
    return "";
  }

  function showTapLabel(html, clientX, clientY, alert){
    const label = document.getElementById("tapLabel");
    const stage = document.getElementById("stage");
    const rect = stage.getBoundingClientRect();
    const x = clientX - rect.left;
    const y = clientY - rect.top;

    label.style.left = x + "px";
    label.style.top  = y + "px";
    label.innerHTML  = html;
    label.classList.toggle("alert", !!alert);
    label.style.display = "block";

    clearTimeout(showTapLabel._t);
    showTapLabel._t = setTimeout(()=>{ label.style.display="none"; }, 1100);
  }

  function setInfo(prefFull){
    const prefLine = document.getElementById("prefLine");
    const capLine  = document.getElementById("capLine");

    if(!prefFull){
      prefLine.textContent = "県をタップ";
      capLine.textContent  = "—";
      capLine.classList.remove("alertText");
      return;
    }

    const d = DATA[prefFull];
    if(!d){
      prefLine.textContent = prefFull;
      capLine.textContent  = "—";
      capLine.classList.remove("alertText");
      return;
    }

    prefLine.innerHTML = rubyHTML(prefFull, d.pref);

    const mismatch = isMismatch(prefFull, d.capName);
    capLine.innerHTML = mismatch
      ? `⚡ ${rubyHTML(d.capName, d.cap)} ⚡`
      : rubyHTML(d.capName, d.cap);

    capLine.classList.toggle("alertText", mismatch);
  }

  async function loadSVG(){
    const host = document.getElementById("svgHost");
    let txt = "";
    try{
      const res = await fetch(MAP_PATH, { cache: "no-store" });
      if(!res.ok) throw new Error("fetch failed");
      txt = await res.text();
    }catch(e){
      host.innerHTML = `<div style="padding:18px;color:#fff;font-weight:900">地図が読み込めません：${MAP_PATH}</div>`;
      return null;
    }

    host.innerHTML = txt;
    const svg = host.querySelector("svg");
    if(!svg) return null;

    svg.setAttribute("viewBox", VIEWBOX);
    svg.setAttribute("preserveAspectRatio", "xMidYMid meet");
    svg.classList.add("geolonia-svg-map");
    return svg;
  }

  function setup(svg){
    const prefectures = Array.from(svg.querySelectorAll(".prefecture"));
    const targets = [];

    prefectures.forEach(g=>{
      const ok = TARGET_CLASSES.some(cls => g.classList.contains(cls));
      if(ok){
        g.classList.add("is-target");
        targets.push(g);
      }else{
        g.classList.add("not-target");
      }
    });

    targets.forEach(g=>{
      const raw = pickPrefName(g);
      let prefFull = raw;

      if(prefFull && prefFull !== "北海道" && !/(都|道|府|県)$/.test(prefFull)){
        prefFull = prefFull + "県";
      }
      g.dataset.prefFull = prefFull;
    });

    svg.querySelectorAll("title,desc").forEach(n=>n.remove());

    targets.forEach(g=>{
      g.addEventListener("pointerdown", (ev)=>{
        const prefFull = g.dataset.prefFull || "";
        if(!prefFull) return;

        const cx = ev.clientX ?? 0;
        const cy = ev.clientY ?? 0;

        const d = DATA[prefFull];
        const mismatch = d ? isMismatch(prefFull, d.capName) : false;

        const labelHtml = d
          ? rubyHTML(prefFull, d.pref)
          : prefFull;

        showTapLabel(labelHtml, cx, cy, mismatch);
        setInfo(prefFull);
      }, { passive:true });
    });

    setInfo("");
  }

  (async ()=>{
    const svg = await loadSVG();
    if(!svg) return;
    setup(svg);
  })();
</script>

</body>
</html>